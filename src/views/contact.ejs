<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1><i class="bi bi-person-lines-fill"></i> Database Kontak</h1>
      <p class="mb-0">Kelola kontak instansi dan pejabat</p>
    </div>
    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addContactModal">
      <i class="bi bi-plus-circle"></i> Tambah Kontak
    </button>
  </div>
</div>

<!-- Contact Cards -->
<div class="row g-4">
  <% if (contactList && contactList.length > 0) { %>
    <% contactList.forEach(item => { %>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px; font-size: 24px;">
                <i class="bi bi-person-fill"></i>
              </div>
              <div>
                <h5 class="card-title mb-0"><%= item.nama %></h5>
                <small class="text-muted"><%= item.jabatan || '-' %></small>
              </div>
            </div>
            
            <hr>
            
            <div class="mb-2">
              <i class="bi bi-building text-primary"></i>
              <strong>Instansi:</strong> <%= item.instansi || '-' %>
            </div>
            
            <div class="mb-2">
              <i class="bi bi-telephone text-success"></i>
              <strong>Telepon:</strong> 
              <a href="tel:<%= item.noTelepon %>"><%= item.noTelepon || '-' %></a>
            </div>
            
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-sm btn-outline-primary flex-fill" onclick="window.editContact(<%= item.id %>)">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger flex-fill" onclick="window.deleteContact(<%= item.id %>)">
                <i class="bi bi-trash"></i> Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <div class="col-12">
      <div class="text-center py-5">
        <i class="bi bi-person-x display-1 text-muted"></i>
        <h3 class="mt-3 text-muted">Belum ada kontak</h3>
        <p class="text-muted">Klik tombol "Tambah Kontak" untuk menambah kontak baru</p>
      </div>
    </div>
  <% } %>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Tambah Kontak Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addContactForm">
          <div class="mb-3">
            <label class="form-label">Nama Lengkap</label>
            <input type="text" class="form-control" name="nama" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Instansi</label>
            <input type="text" class="form-control" name="instansi">
          </div>
          <div class="mb-3">
            <label class="form-label">Jabatan</label>
            <input type="text" class="form-control" name="jabatan">
          </div>
          <div class="mb-3">
            <label class="form-label">No. Telepon</label>
            <input type="tel" class="form-control" name="noTelepon">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" onclick="window.saveContact()">
          <i class="bi bi-save"></i> Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Edit Kontak</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editContactForm">
          <input type="hidden" id="editContactId" name="id">
          <div class="mb-3">
            <label class="form-label">Nama Lengkap</label>
            <input type="text" class="form-control" id="editNama" name="nama" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Instansi</label>
            <input type="text" class="form-control" id="editInstansi" name="instansi">
          </div>
          <div class="mb-3">
            <label class="form-label">Jabatan</label>
            <input type="text" class="form-control" id="editJabatan" name="jabatan">
          </div>
          <div class="mb-3">
            <label class="form-label">No. Telepon</label>
            <input type="tel" class="form-control" id="editNoTelepon" name="noTelepon">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" onclick="window.updateContact()">
          <i class="bi bi-save"></i> Update
        </button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
window.saveContact = async function() {
  const form = document.getElementById('addContactForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('/api/contact', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      alert('Kontak berhasil ditambahkan!');
      location.reload();
    } else {
      alert('Gagal menambahkan kontak: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

window.deleteContact = async function(id) {
  if (!confirm('Yakin ingin menghapus kontak ini?')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/contact/${id}`, { 
      method: 'DELETE',
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      alert('Kontak berhasil dihapus!');
      location.reload();
    } else {
      alert('Gagal menghapus kontak: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

// Edit Contact - Load data and show modal
window.editContact = async function(id) {
  try {
    const response = await fetch(`/api/contact/${id}`, {
      credentials: 'same-origin'
    });
    const result = await response.json();
    
    if (response.ok && result.success) {
      const item = result.data;
      
      // Fill form with data
      document.getElementById('editContactId').value = item.id;
      document.getElementById('editNama').value = item.nama || '';
      document.getElementById('editInstansi').value = item.instansi || '';
      document.getElementById('editJabatan').value = item.jabatan || '';
      document.getElementById('editNoTelepon').value = item.noTelepon || '';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editContactModal'));
      modal.show();
    } else {
      alert('Gagal memuat data kontak: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

// Update Contact
window.updateContact = async function() {
  const form = document.getElementById('editContactForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  const id = data.id;
  
  // Remove id from data
  delete data.id;
  
  try {
    const response = await fetch(`/api/contact/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      alert('Kontak berhasil diupdate!');
      location.reload();
    } else {
      alert('Gagal mengupdate kontak: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}
</script>
