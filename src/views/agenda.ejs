<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1><i class="bi bi-calendar-event"></i> Agenda Kegiatan</h1>
      <p class="mb-0">Kelola jadwal perjalanan dinas direksi</p>
    </div>
    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addAgendaModal">
      <i class="bi bi-plus-circle"></i> Tambah Agenda
    </button>
  </div>
</div>

<!-- Filter Section -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <input type="text" class="form-control" id="searchAgenda" placeholder="Cari kegiatan...">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="filterStatus">
          <option value="">Semua Status</option>
          <option value="ON SCHEDULE">On Schedule</option>
          <option value="DELAYED">Delayed</option>
          <option value="COMPLETED">Completed</option>
          <option value="CANCELLED">Cancelled</option>
        </select>
      </div>
      <div class="col-md-3">
        <input type="date" class="form-control" id="filterDate">
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100" onclick="filterAgenda()">
          <i class="bi bi-funnel"></i> Filter
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Agenda List -->
<div class="row g-4" id="agendaList">
  <% if (agendaList && agendaList.length > 0) { %>
    <% agendaList.forEach(item => { %>
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100 agenda-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <h5 class="card-title mb-0"><%= item.kegiatan %></h5>
              <span class="badge <%= item.status === 'ON SCHEDULE' ? 'bg-success' : item.status === 'DELAYED' ? 'bg-warning' : item.status === 'COMPLETED' ? 'bg-info' : 'bg-secondary' %>">
                <%= item.status %>
              </span>
            </div>
            
            <div class="mb-3">
              <p class="text-muted mb-2">
                <i class="bi bi-calendar3 text-primary"></i> 
                <%= new Date(item.tanggal).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
              </p>
              <p class="text-muted mb-2">
                <i class="bi bi-clock text-primary"></i> 
                <%= item.waktu %>
              </p>
              <% if (item.lokasi) { %>
                <p class="text-muted mb-2">
                  <i class="bi bi-geo-alt text-primary"></i> 
                  <%= item.lokasi %>
                </p>
              <% } %>
            </div>

            <% if (item.pesertaInternal || item.pesertaExternal) { %>
              <div class="mb-3">
                <h6 class="mb-2">Peserta:</h6>
                <% if (item.pesertaInternal) { %>
                  <p class="small mb-1"><strong>Internal:</strong> <%= item.pesertaInternal %></p>
                <% } %>
                <% if (item.pesertaExternal) { %>
                  <p class="small mb-1"><strong>External:</strong> <%= item.pesertaExternal %></p>
                <% } %>
              </div>
            <% } %>

            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="window.editAgenda(<%= item.id %>)">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="window.deleteAgenda(<%= item.id %>)">
                <i class="bi bi-trash"></i> Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <div class="col-12">
      <div class="text-center py-5">
        <i class="bi bi-calendar-x display-1 text-muted"></i>
        <h3 class="mt-3 text-muted">Belum ada agenda</h3>
        <p class="text-muted">Klik tombol "Tambah Agenda" untuk membuat agenda baru</p>
      </div>
    </div>
  <% } %>
</div>

<!-- Add Agenda Modal -->
<div class="modal fade" id="addAgendaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Tambah Agenda Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addAgendaForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Tanggal</label>
              <input type="date" class="form-control" name="tanggal" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Waktu</label>
              <input type="time" class="form-control" name="waktu" required>
            </div>
            <div class="col-12">
              <label class="form-label">Kegiatan</label>
              <textarea class="form-control" name="kegiatan" rows="3" required></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Lokasi</label>
              <input type="text" class="form-control" name="lokasi">
            </div>
            <div class="col-md-6">
              <label class="form-label">Peserta Internal</label>
              <textarea class="form-control" name="pesertaInternal" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Peserta External</label>
              <textarea class="form-control" name="pesertaExternal" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" name="status">
                <option value="ON SCHEDULE">On Schedule</option>
                <option value="DELAYED">Delayed</option>
                <option value="COMPLETED">Completed</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" onclick="window.saveAgenda()">
          <i class="bi bi-save"></i> Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Agenda Modal -->
<div class="modal fade" id="editAgendaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Edit Agenda</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editAgendaForm">
          <input type="hidden" id="editAgendaId" name="id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Tanggal</label>
              <input type="date" class="form-control" id="editTanggal" name="tanggal" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Waktu</label>
              <input type="time" class="form-control" id="editWaktu" name="waktu" required>
            </div>
            <div class="col-12">
              <label class="form-label">Kegiatan</label>
              <textarea class="form-control" id="editKegiatan" name="kegiatan" rows="3" required></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Lokasi</label>
              <input type="text" class="form-control" id="editLokasi" name="lokasi">
            </div>
            <div class="col-md-6">
              <label class="form-label">Peserta Internal</label>
              <textarea class="form-control" id="editPesertaInternal" name="pesertaInternal" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Peserta External</label>
              <textarea class="form-control" id="editPesertaExternal" name="pesertaExternal" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" id="editStatus" name="status">
                <option value="ON SCHEDULE">On Schedule</option>
                <option value="DELAYED">Delayed</option>
                <option value="COMPLETED">Completed</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" onclick="window.updateAgenda()">
          <i class="bi bi-save"></i> Update
        </button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
window.saveAgenda = async function() {
  const form = document.getElementById('addAgendaForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('/api/agenda', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      alert('Agenda berhasil ditambahkan!');
      location.reload();
    } else {
      alert('Gagal menambahkan agenda: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

window.editAgenda = async function(id) {
  try {
    const response = await fetch(`/api/agenda/${id}`, {
      credentials: 'same-origin'
    });
    const result = await response.json();
    
    if (response.ok && result.success) {
      const item = result.data;
      
      // Fill form with data
      document.getElementById('editAgendaId').value = item.id;
      document.getElementById('editTanggal').value = item.tanggal;
      document.getElementById('editWaktu').value = item.waktu;
      document.getElementById('editKegiatan').value = item.kegiatan || '';
      document.getElementById('editLokasi').value = item.lokasi || '';
      document.getElementById('editPesertaInternal').value = item.pesertaInternal || '';
      document.getElementById('editPesertaExternal').value = item.pesertaExternal || '';
      document.getElementById('editStatus').value = item.status || 'ON SCHEDULE';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editAgendaModal'));
      modal.show();
    } else {
      alert('Gagal memuat data agenda: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

window.updateAgenda = async function() {
  const form = document.getElementById('editAgendaForm');
  const formData = new FormData(form);
  const data = Object.fromEntries(formData);
  const id = data.id;
  
  // Remove id from data
  delete data.id;
  
  try {
    const response = await fetch(`/api/agenda/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      alert('Agenda berhasil diupdate!');
      location.reload();
    } else {
      alert('Gagal mengupdate agenda: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

window.deleteAgenda = async function(id) {
  if (!confirm('Yakin ingin menghapus agenda ini?')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/agenda/${id}`, { 
      method: 'DELETE',
      credentials: 'same-origin'
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      alert('Agenda berhasil dihapus!');
      location.reload();
    } else {
      alert('Gagal menghapus agenda: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
  }
}

function filterAgenda() {
  const search = document.getElementById('searchAgenda').value.toLowerCase();
  const status = document.getElementById('filterStatus').value;
  const date = document.getElementById('filterDate').value;
  
  const cards = document.querySelectorAll('.agenda-card');
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    const cardStatus = card.querySelector('.badge').textContent.trim();
    
    let show = true;
    if (search && !text.includes(search)) show = false;
    if (status && cardStatus !== status) show = false;
    
    card.closest('.col-md-6').style.display = show ? 'block' : 'none';
  });
}
</script>
